(function(n,t,i){function e(){n.extend({firstExists:function(){var t;return n.each(arguments,function(i,r){if(!r)return!0;var u=typeof r=="string"?n(r):r;return u.exists()?(t=u,!1):!0}),t||n("body")}}),n.fn.extend({autocomplete:function(t){var i=null,u=null,f=null,e="",o=[],r=n.extend({source:[],minLength:2,maxResults:10,resultsClass:"loom-autocomplete-results",delay:200},t);this.attr("autocomplete","off"),i=n('<div class="dropdown"></div>').addClass(r.resultsClass).css("position","absolute").appendTo(this.parent()).on({click:function(){i.hide().data("loomOwner").val(n(this).text()).focus()},mouseover:function(){i.find("li.active").removeClass("active")}},"li a");var s=function(n,t){var e,r,u,f;if(!t)return;e=t.length;if(e===0){i.empty().hide();return}for(r='<ul class="dropdown-menu autocomplete-menu" role="menu" style="position:relative; overflow-y:auto;">',u=0;u<t.length;u++){f=t[u];if(!f)continue;r+='<li role="presentation"><a href="javascript:void(0);">'+f+"</a></li>"}r+="</ul>",i.html(r).show().find(".dropdown-menu").show().height(i.find("li:first").height()*7).find("li:first").addClass("active")},c=function(t,i,r){var u=t.val(),f;if(u===e){r(t,o);return}e=u,f={term:t.val()},n.getJSON(i,f,function(n){o=n,typeof r=="function"&&r(t,n)})},l=function(t){return t.height()<t[n.fn.prop?"prop":"attr"]("scrollHeight")},a=function(n){return n===f?!1:n.length<r.minLength?(i.hide().empty(),f=n,!1):(f=n,!0)},v=function(n){u&&clearTimeout(u),typeof r.source=="string"?u=setTimeout(function(){if(!a(n.val()))return;c(n,p$.resolveUrl(r.source),s)},r.delay):s(n,r.source)},h=function(n){var t=i.find("li.active").removeClass("active"),r;n>0?(t=t.next(),t.length===0&&(t=i.find("li:first"))):(t=t.prev(),t.length===0&&(t=i.find("li:last"))),r=t.parent(),r.height(t.height()*7);if(l(r)){var u=t.offset().top-r.offset().top,f=r.scrollTop(),e=r.height();u<0?r.scrollTop(f+u-1):u<e||r.scrollTop(f+u-e+t.height()-1)}t.length>0&&(t.addClass("active"),i.show())},y=function(n){var t=i.find("li.active a");t.length>0&&n.val(t.text())};this.on({keydown:function(t){var r=n(t.target);switch(t.keyCode){case 38:t.preventDefault(),h(-1);break;case 40:t.preventDefault(),h(1);break;case 9:case 13:y(r),i.hide();break;case 27:i.hide();default:v(r)}},blur:function(){setTimeout(function(){i.hide().empty()},200)},focus:function(t){var r=n(t.target),u=i.data("loomOwner");u&&u[0]!=r[0]&&i.empty(),i.data("loomOwner",r)}});return this},dataBind:function(t,i){function a(n,t,i,r){var o=function(n,t,i,r,u,e){var c=function(n,t){e&&e!=="text"?n.attr(e,t):n.html(t)},l=function(n){var u=n.match(f),t,r;if(u)for(t=0;t<u.length;t++)r=u[t],n=n.replace(r,i[r.substring(2,r.length-1)]);return n},s,h;if(typeof t=="string")c(n,l(t));else if(typeof t=="object")for(h in t){s=t[h];if(h==="style"){typeof s=="object"?n.css(s):typeof s=="function"&&n.css(s({data:i,elem:n,item:u,i:r}));continue}o(n,s,i,r,u,h)}else typeof t=="function"?c(n,t({data:i,elem:n,item:u,i:r})):c(n,t)},e,u,c,s,h;i.data("loomData",t),i.addClass("loomDataItem");for(e in t)r&&r[e]||(u=i.find("."+e),u.length===0&&i.hasClass(e)&&(u=i),c=u.text(),c.length>0?o(u,c,t,n,i):u.text(t[e]));for(s in r)h=i.find("."+s),h.length===0&&i.hasClass(s)&&(h=i),o(h,r[s],t,n,i);delete o}var u,h,l,o;if(t.length&&t.length===0)return this;u=this.data("loomParent"),u||(this.dataTemplate(),u=this.data("loomParent"));if(!t||!t.length&&n.isEmptyObject(t)||t.length===0||t.length>0&&n.isEmptyObject(t[0]))return u.empty(),this;var c=this.data("loomTemplateHtml"),v=this.data("loomSeperatorHtml"),s=this.data("loomTemplateOptions"),r,e;e=t.length&&t.length!==1?n("<div></div>"):u;if(i)if(i==="append")r=e.append(c).children(":last");else if(i==="prepend")r=n(e.prepend(c).children()[0]);else throw"Invalid dataBind option";else r=n(e.html(c).children()[0]);h=s.itemBound&&typeof s.itemBound=="function"?s.itemBound:null;if(t.length)for(o=0;o<t.length;o++)l=t[o],a(o,l,r,s.format),h&&h(r,l,o),o<t.length-1&&(v&&(r=r.after(v).next()),r=r.after(c).next());else a(0,t,r,s.format),h&&h(r,t,0);return t.length&&t.length>1&&(i?i==="append"?u.append(e.children()):i==="prepend"&&u.prepend(e.children()):u.empty().append(e.children())),this.show()},dataTemplate:function(t){var i=n.extend({itemTemplate:n(this.children(":not(thead, tfoot)")[0])},t),u=this.data("loomParent"),r,f;if(u)return this;r=i.itemTemplate instanceof jQuery?i.itemTemplate:this.find(i.itemTemplate),r&&r.is("tbody")&&(r=r.find("tr:first"));var e=this.find(i.seperatorTemplate),o=this.find(i.emptyTemplate),s=this.find(i.alternatingTemplate);if(r.length===0)throw this.selector+": No itemTemplate specified and/or element has no children";u=r.parent(),this.data("loomParent",u),this.data("loomTemplateOptions",i),this.data("loomTemplateHtml",r.wrap("<div></div>").parent().html()),e.length>0&&this.data("loomSeperatorHtml",e.wrap("<div></div>").parent().html()),o.length>0&&this.data("loomEmptyHtml",o.wrap("<div></div>").parent().html()),s.length>0&&this.data("loomAlternatingHtml",s.wrap("<div></div>").parent().html());if(i.events)for(f in i.events)u.bind(f,function(t){var r=n(t.target).closest(".loomDataItem"),u=i.events[f];return r.length===0?!0:u(t,r.data("loomData"),r)});return u.empty(),this},exists:function(){return this.length!==0},findOrDefault:function(n){return n instanceof jQuery?n:this.find(n)},jsonPost:function(t,i){return this.each(function(){var u=n(this),r=n.extend({event:"click",form:"form",targetOrigin:!1,url:u.attr("href")},t);u.bind(r.event,function(t){t.preventDefault(),t.stopPropagation();if(!i||i&&i(t)!==!1){var u=typeof r.form=="string"?(r.targetOrigin?n(t.target):n(this)).closest(r.form):r.form;r.form=u instanceof jQuery?u:n(u),p$.jsonPost(r)}})})},log:function(t){return this.each(function(){p$.debug.log(t,n(this))})},messageBox:function(){return this.hide(),t.messageBox=this,!this.html().length==0&&this.append("<div></div>").find("div").append('<span class="title"></span>').append('<p class="message"></p>'),this.dataTemplate({itemBound:function(n,t){n.attr("class",t.type)},format:{message:{text:function(n){return n.data.message},href:function(n){return n.data.message}}}}),this},scrollView:function(t){return this.each(function(){n("html, body").animate({scrollTop:n(this).offset().top},t||1e3)})},serializeObject:function(t,r){function e(n,t,u){n[t]!==i?(n[t].push||(n[t]=[n[t]]),(u||r)&&n[t].push(u)):(u||r)&&(n[t]=u)}var o=function(i){return t&&t[i.name]?n.isFunction(t[i.name])?t[i.name](i.value):t[i.name]:i.value},u={},s=this.serializeArray(),f;n.each(s,function(){var n=this.name.split("."),t=o(this),f;n.length>1?u[n[0]]===i?(f={},(t||r)&&(f[n[1]]=t),u[n[0]]=f):e(u[n[0]],n[1],t):e(u,this.name,t)});for(f in t)u[f]||(u[f]=n.isFunction(t[f])?t[f]():t[f]);return u},selectRange:function(n,t){return this.each(function(){if(this.createTextRange){var i=this.createTextRange();i.collapse(!0),i.moveStart("character",n),i.moveEnd("character",t),i.select()}else this.setSelectionRange?this.setSelectionRange(n,t):this.selectionStart&&(this.selectionStart=n,this.selectionEnd=t);this.focus()})},fadeRemove:function(t,i){return n(this).fadeOut(t,function(){n(this).remove(i)}),this}}),n.ajaxSetup({converters:{"text msjson":function(t){try{var i=n.parseJSON(t);return i.hasOwnProperty("d")?i.d:i}catch(r){return{messageBox:{type:"error",title:"Error Parsing Response",message:"Could not parse the server response."}}}}}})}var u,r,f;return navigator.userAgent.match(/IEMobile\/10\.0/)&&(u=document.createElement("style"),u.appendChild(document.createTextNode("@-ms-viewport{width:auto!important}")),document.getElementsByTagName("head")[0].appendChild(u)),e(),r=function(){var r=function(){return new r.fn.Init},u,f;return r.fn=r.prototype={constructor:r,Init:function(){return r}},r.fn.Init.prototype=r.fn,u=function(t){return typeof t=="string"?n(t):t},f=n({}),r.extend=r.fn.extend=function(){var o,e,u,r,s=!1,h,t=arguments[0]||{},f=1,c=arguments.length,l=!1;for(typeof t=="boolean"&&(l=!0,t=arguments[1]||{},f=2),typeof t=="object"||n.isFunction(t)||(t={}),c===f&&(t=this,--f);f<c;f++)if((o=arguments[f])!=null)for(e in o){u=t[e],r=o[e];if(t===r)continue;l&&r&&(n.isPlainObject(r)||(s=n.isArray(r)))?(s?(s=!1,h=u&&n.isArray(u)?u:[]):h=u&&n.isPlainObject(u)?u:{},t[e]=n.extend(!0,h,r)):r!==i&&(t[e]=r)}return t},r.extend({relativeAppPath:"/",mainContent:n.firstExists("#mainContent","#content"),getTargetData:function(t){var i=t.closest(".nav"),u=t.closest(".context"),f=n.firstExists(t.data("loomTarget"),u.data("loomTarget"),i.data("loomTarget"),t.closest(".dynamic"),r.mainContent);return{nav:i,context:u,target:f}},run:function(){var i={selector:"a:not(.dropdown-toggle)",events:{click:function(t){var f,i,e,u;t.preventDefault(),r.debug.log("async anchor clicked"),f=n(t.currentTarget),i=f.attr("href");if(f.data("isModal")===!0){r.debug.log("isModal"),r.loadModal(i);return}e=r.getTargetData(f);if(e.target!=r.mainContent){r.debug.log("loomTarget",e.target),r.loadView(e.target,i);return}if(i.indexOf("#!",0)>0){document.location=i;return}u=i.split("#");if(u.length===1){document.location=u[0];return}i=u[1];if(!i||i.length===0||i==="index"){document.location=u[0];return}r.debug.log("NavigateTo",i),document.location.hash="!"+i}}},u={selector:".dynamic",events:{updated:function(t){var i=n(t.target);i.find(".loom-templated").each(function(){var t=n(this),i=p$.resolveUrl(t.data("loomDatasource"));i&&n.getJSON(i,null,function(n){t.dataTemplate().dataBind(n.d)})}),i.find(".autocomplete").each(function(){var i=n(this),t=i.data("loomOptions"),r={};t&&t.autocomplete&&(r=t.autocomplete),i.autocomplete(r)}),i.find(".json-post input[type=submit]").jsonPost()}}},f={events:{hashchange:function(){var u=t.location.hash,f,i;if(!u)return;r.debug.log("hashchange",u),f=n("body").find('a[href="'+u.replace("!","")+'"]'),i=r.getTargetData(f),r.navigateTo(u,i.target),r.debug.log("target data",i),i.nav.exists()&&(i.nav.find("li.active").removeClass("active"),f.closest(".nav li").addClass("active"))}}};n("body.spa").on(i.events,i.selector).on(u.events,u.selector);n(t).on(f.events).trigger("hashchange")},redirectIfRequired:function(n){var t=n.getResponseHeader("X-Portal-Location");return t&&t.length>0?(r.debug.log("Portal redirect to",t),top.location.href=r.resolveUrl(t),!0):!1},resolveUrl:function(n,t){var i=function(n,t){return t&&t.length>0&&t.substr(0,1)==="~"&&(t=t.substr(1,t.length-1)),t&&t.length>0&&t.substr(0,1)!=="/"&&(t="/"+t),!n||n==="/"?t:(n.length>1&&n.substr(n.length-1,1)==="/"&&(n=n.substr(0,n.length-1)),n+t)},u=function(n){return n.indexOf(":")!==-1?!1:!f(n)},f=function(n){return n&&n.length>0&&n.substr(0,1)!=="/"?n.substr(0,1)==="\\":!0};return n?n.length===0||!u(n)?n:i(t||r.relativeAppPath,n):n},loadView:function(t,i){i=i&&i.length>0?i.replace(/^#!/,"").replace(/^#/,""):document.location.hash.replace(/^#!/,""),n.ajax(i+(i.indexOf("/")>0?"":"/index"),{type:"GET",dataType:"html",success:function(n,i,u){r.debug.log("Load view success",u),r.redirectIfRequired(u)||t.html(n).trigger("updated").show()}})},loadModal:function(t){t=t&&t.length>0?t.replace(/^#!/,"").replace(/^#/,""):document.location.hash.replace(/^#!/,"");var i=n("#modal");i.on("click",".closer",function(){i.hide()});n.ajax(t+(t.indexOf("/")>0?"":"/index"),{type:"GET",cache:!1,dataType:"html",success:function(n){i.children(".content").html(n),i.trigger("updated").show()}})},throwError:function(n){var t=new Error;t.message=n.message,t.name=n.name;if(t.stack){var i=t.stack.split("\n")[2],r=i.lastIndexOf(":"),u=i.slice(r+1,i.length);t.lineNumber=u}throw t;},navigateTo:function(n,t){n&&n.length!==0&&n!=="#"||r.throwError({message:"portal.navigateTo(loc): The navigate location was not supplied. Possible causes include a blank href attribute. (Parameter: loc).",name:"navigationException"}),r.loadView(t)},ajaxQueue:function(t){var i=t.complete;f.queue(function(r){t.complete=function(){i&&i.apply(this,arguments),r()},n.ajax(t)})},jsonPost:function(i){var f=n.extend({contentType:"application/json; charset=utf-8",dataType:"json",cache:!1,serializeEmpty:!1},i),o=function(n){var i=n.response,r;if(!i)return;if(typeof i=="string"){if(!n.target)return;n.target.html(i)}else if(typeof i=="object")if(i.hasOwnProperty("messageBox")){r=n.target||t.messageBox;if(!r)return;r.dataBind(i.messageBox).show()}else{if(!n.target)return;n.target.dataBind(i)}},e;return f.form=u(f.form),f.form&&(f.url=f.url||f.form.attr("action"),f.dtoName=f.dtoName||f.form.attr("name")),e=f.dtoName?f.form?'{"'+f.dtoName+'":'+JSON.stringify(f.form.find(":input[name]").serializeObject(f.data,f.serializeEmpty))+"}":'{"'+f.dtoName+'":'+JSON.stringify(f.data)+"}":f.form?JSON.stringify(f.form.find(":input[name]").serializeObject(f.data,f.serializeEmpty)):JSON.stringify(f.data),f.target=u(f.target),r.debug.log("jsonPost",f),n.ajax({url:r.resolveUrl((f.url?f.url:location.href)+(f.method?"/"+f.method:"")),type:"POST",data:e,dataType:f.dataType,contentType:f.contentType,cache:f.cache,beforeSend:function(n){var t={};return t.ajaxRequest=this,t.XmlHttpRequest=n,t.target=f.target,t.form=f.form,typeof f.beforeSend!="function"?!0:f.beforeSend(t)},success:function(n,t){var i={},r=!0;i.ajaxRequest=this,i.response=n,i.statusText=t,i.target=f.target,i.form=f.form,f.success&&(r=f.success(i)),r!==!1&&o(i)},error:function(n,t,i){if(t==="parsererror"){alert(t);return}var r={},u=JSON.parse(n.responseText);r.ajaxRequest=this,r.XmlHttpRequest=n,r.errorStatus=t,r.scriptError=i,r.serverError=u,r.target=f.target,r.form=f.form,f.error?f.error(r):u&&u.hasOwnProperty("Message")?alert(u.Message):alert(t)},complete:function(n,t){var i={},u;i.ajaxRequest=this,i.XmlHttpRequest=n,i.statusText=t,i.target=f.target,i.form=f.form,u=null,f.complete&&(u=f.complete(i)),u!==!1&&r.redirectIfRequired(n)}}),!1},toFormParams:function(t){function u(n,t){r[r.length]={name:n,value:t}}var r=[],i;if(n.isArray(t)||t.jquery)n.each(t,function(){u(this.name,this.value)});else for(i in t)n.isArray(t[i])?n.each(t[i],function(){u(i,this)}):u(i,n.isFunction(t[i])?t[i]():t[i]);return r},dataToList:function(t,i){for(var r=n.extend({},i),o=(r.listId?' id="'+r.listId+'"':"")+(r.listClass?' class="'+r.listClass+'"':""),s=r.itemClass?' class="'+r.itemClass+'"':"",f="<ul"+o+">",e,u=0;u<t.length;u++){e=t[u];if(!e)continue;f+="<li"+s+">"+e+"</li>"}return f+="</ul>"},routes:function(){},models:function(){},views:function(){},controllers:function(){},debug:{log:function(n,i,r){t.console&&t.console.log&&(i?r?t.console.log("%s: %o %o",n,r,i):t.console.log("%s: %o",n,i):t.console.log("%s",n))},warn:function(n,i,r){t.console&&t.console.warn&&(i?r?t.console.warn("%s: %o %o",n,r,i):t.console.warn("%s: %o",n,i):t.console.warn("%s",n))},info:function(n,i,r){t.console&&t.console.info&&(i?r?t.console.info("%s: %o %o",n,r,i):t.console.info("%s: %o",n,i):t.console.info("%s",n))},group:function(n,i,r){t.console&&t.console.group&&(i?r?t.console.group("%s: %o %o",n,r,i):t.console.group("%s: %o",n,i):t.console.group("%s",n))},groupCollapsed:function(n,i,r){t.console&&t.console.groupCollapsed&&(i?r?t.console.groupCollapsed("%s: %o %o",n,r,i):t.console.groupCollapsed("%s: %o",n,i):t.console.groupCollapsed("%s",n))},groupEnd:function(){t.console&&t.console.groupEnd&&t.console.groupEnd()},assert:function(n){t.console&&t.console.assert&&t.console.assert(n)},logIf:function(n,t){if(!t)return;r.debug.log(n,t)}}}),r}(),f=/\$\{\w+\}/g,t.portal=t.p$=new r,n(function(){r.run()}),r})(jQuery,window),jQuery.event.special.enterpress||(jQuery.event.special.enterpress={setup:function(){$(this).bind("keydown",jQuery.event.special.enterpress.handler)},teardown:function(){$(this).unbind("keydown",jQuery.event.special.enterpress.handler);return},handler:function(n){n.which===13&&(n.type="enterpress",jQuery.event.dispatch.apply(this,arguments))}}),jQuery.event.special.tabpress||(jQuery.event.special.tabpress={setup:function(){$(this).bind("keydown",jQuery.event.special.tabpress.handler)},teardown:function(){$(this).unbind("keydown",jQuery.event.special.tabpress.handler);return},handler:function(n){var t=n.keyCode||n.which;t===9&&(n.type="tabpress",jQuery.event.dispatch.apply(this,arguments))}}),jQuery.event.special.escpress||(jQuery.event.special.escpress={setup:function(){$(this).bind("keydown",jQuery.event.special.escpress.handler)},teardown:function(){$(this).unbind("keydown",jQuery.event.special.escpress.handler);return},handler:function(n){var t=n.keyCode||n.which;t===27&&(n.type="escpress",jQuery.event.dispatch.apply(this,arguments))}}),String.prototype.startsWith||(String.prototype.startsWith=function(n){return this.lastIndexOf(n,0)===0}),String.prototype.endsWith||(String.prototype.endsWith=function(n){return this.indexOf(n,this.length-n.length)!==-1}),Array.prototype.remove||(Array.prototype.remove=function(n,t){return this.splice(n,!t||1+t-n+(!(t<0^n>=0)&&(t<0||-1)*this.length)),this.length});